@page "/"
@inject NavigationManager Navigation
@using System.Collections.Generic
@using MudBlazor
@using student_management_fe.Models

<MudText Typo="Typo.h4" Class="mb-4" Align="Align.Center" Color="Color.Primary" Style="font-weight: bold;">
    Danh sách sinh viên
</MudText>

<MudPaper Class="search-bar" Elevation="3" Style="padding:16px; margin-bottom:20px;">
    <MudGrid>
        <MudItem xs="12" sm="12">
            <MudTextField @bind-Value="searchText"
                          Placeholder="Nhập tên hoặc MSSV"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          Variant="Variant.Outlined"
                          OnKeyDown="HandleKeyPressSearch"
                          Class="w-100" />
        </MudItem>
        <MudItem xs="12" sm="12" Class="d-flex justify-end">
            <MudButton Color="Color.Secondary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.FilterList" OnClick="ToggleFilter" Class="me-2">
                Bộ lọc
            </MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Search" OnClick="SearchStudents" Class="me-2">
                Tìm kiếm
            </MudButton>
            <MudMenu Label="Thêm mới" Color="Color.Success" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Class="me-2">

                <MudMenuItem OnClick="AddStudent">
                    Thêm sinh viên
                </MudMenuItem>
                <MudMenuItem OnClick="ImportExcel">
                    Nhập từ Excel
                </MudMenuItem>

            </MudMenu>
          
            <MudButton Color="Color.Info" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.FileDownload" OnClick="ExportToExcel" Class="me-2">
                Xuất Excel
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (showFilter)
    {
        <MudPaper Class="mt-4 pa-4" Elevation="1" Style="background-color: #f9f9f9;">
            <MudGrid>
                <MudItem xs="12" sm="12">
                    <MudSelect T="string"
                               Label="Chọn khoa"
                               @bind-SelectedValues="selectedFaculties"
                               MultiSelection="true"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var faculty in faculties)
                        {
                            <MudSelectItem Value="@faculty.Name">@faculty.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }

</MudPaper>

<MudPaper Class="table-container" Elevation="4">
    <MudTable RowClass="cursor-pointer" OnRowClick="RowClickEvent" T="StudentHomePageModel" Items="students" Dense="true" Hover="true" Bordered="true" Striped="true">
        <HeaderContent>
            <MudTh Style="text-align: center">STT</MudTh>
            <MudTh Style="text-align: center">MSSV</MudTh>
            <MudTh Style="text-align: center">Họ và tên</MudTh>
            <MudTh Style="text-align: center">Ngày sinh</MudTh>
            <MudTh Style="text-align: center">Giới tính</MudTh>
            <MudTh Style="text-align: center" >Khoa</MudTh>
            <MudTh Style="text-align: center">Khóa</MudTh>
            <MudTh Style="text-align: center">Chương trình</MudTh>
            <MudTh Style="text-align: center">Tình trạng</MudTh>
            <MudTh Style="text-align: center">Thao tác</MudTh>
        </HeaderContent>
 

        <RowTemplate>
            <MudTd Style="text-align: center" DataLabel="STT">@((students.IndexOf(context) + 1) + (currentPage - 1) * pageSize)</MudTd>
            <MudTd DataLabel="MSSV">@context.Id</MudTd>
            <MudTd DataLabel="Họ và tên">@context.FullName</MudTd>
            <MudTd DataLabel="Ngày sinh">@context.DateOfBirth?.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Giới tính">@context.Gender</MudTd>
            <MudTd DataLabel="Khoa">@ConvertIdToFacultyName(context.FacultyId)</MudTd>
            <MudTd DataLabel="Khóa">@context.IntakeYear</MudTd>
            <MudTd DataLabel="Chương trình">@ConvertIdToStudyProgramName(context.ProgramId)</MudTd>
            <MudTd DataLabel="Tình trạng">@ConvertIdToStudentStatusName(context.StatusId)</MudTd>
            <MudTd Style="text-align: center" DataLabel="Thao tác">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Info" OnClick="()=>EditStudent(context.Id)" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="()=>DeleteStudent(context.Id)" />
            </MudTd>
        </RowTemplate>

         <NoRecordsContent>
            <MudText>Không tìm thấy dữ liệu...</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>Đang tải...</MudText>
        </LoadingContent>
    </MudTable>
</MudPaper>

<MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center" Class="mt-4 mb-4">
    <MudItem>
        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="PreviousPage" Disabled="@(currentPage <= 1)" StartIcon="@Icons.Material.Filled.ArrowBack">
            Trước
        </MudButton>
    </MudItem>

    <MudItem>
        <MudText Typo="Typo.subtitle1" Class="mx-2" Style="white-space: nowrap;">
            Trang @(totalPages > 0 ? currentPage : 0) / @totalPages
        </MudText>
    </MudItem>

    <MudItem>
        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="NextPage" Disabled="@(currentPage >= totalPages)" EndIcon="@Icons.Material.Filled.ArrowForward">
            Sau
        </MudButton>
    </MudItem>
</MudGrid>